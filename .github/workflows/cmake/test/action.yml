name: CMake test
description: Test project using CMake
inputs:
  artifacts-name:
    description: Artifacts name
    required: false
  build-dir:
    description: CMake build directory
    required: true
  cc:
    description: Sets CMAKE_C_COMPILER
    required: true
  cxx:
    description: Sets CMAKE_CXX_COMPILER
    required: true
  cxx-std:
    description: Sets CMAKE_CXX_STANDARD
    required: true
  gcov:
    description: gcov executable
    required: true
  gcovr-version:
    description: gcovr version
    required: true
  generator:
    description: CMake generator
    required: true
  generator-platform:
    description: Sets CMAKE_GENERATOR_PLATFORM
    required: false
  osx-deployment-target:
    description: Sets CMAKE_OSX_DEPLOYMENT_TARGET
    required: false
  shell:
    description: Shell
    required: true
  source-dir:
    description: CMake source directory
    required: true
  test-wrapper-cmd:
    description: Test wrapper command
    required: false
runs:
  using: composite
  steps:
    - name: gcov version
      run: ${{ inputs.gcov }} --version
      shell: ${{ inputs.shell }}

    - name: Install gcovr
      run: pip install "gcovr==${{ inputs.gcovr-version }}"
      shell: ${{ inputs.shell }}

    - name: Configure
      run: |
        cmake_cmd=(
          cmake
          -G "${{ inputs.generator }}"
          -B "${{ inputs.build-dir }}"
          -S "${{ inputs.source-dir }}"
          -D "CMAKE_C_COMPILER=${{ matrix.cc }}"
          -D "CMAKE_CXX_COMPILER=${{ matrix.cxx }}"
          -D "CMAKE_CXX_STANDARD=${{ matrix.cxx-std }}"
        )
        if [[ ! -z "${{ inputs.generator-platform }}" ]]; then
          cmake_cmd+=(-D "CMAKE_GENERATOR_PLATFORM=${{ inputs.generator-platform }}")
        fi
        if [[ ! -z "${{ inputs.osx-deployment-target }}" ]]; then
          cmake_cmd+=(-D "CMAKE_OSX_DEPLOYMENT_TARGET=${{ inputs.osx-deployment-target }}")
        fi
        "${cmake_cmd[@]}"
      shell: ${{ inputs.shell }}

    - name: Build
      run: >
        cmake
        --build "${{ inputs.build-dir }}"
        --config Profile
      shell: ${{ inputs.shell }}

    - name: Test
      run: |
        config=Profile
        cmake_cmd=()
        if [[ ! -z "${{ inputs.test-wrapper-cmd }}" ]]; then
          cmake_cmd+=("${{ inputs.test-wrapper-cmd }}")
        fi
        cmake_cmd+=(
          ctest
          --test-dir "${{ inputs.build-dir }}"
          --output-on-failure
          --build-config "${config}"
        )
      shell: ${{ inputs.shell }}

    - name: Generate coverage data
      id: prepare-coverage-artifacts
      run: |
        artifact_dir="temp_${RANDOM}/${{ inputs.artifacts-name }}"

        gcovr_args=(
          --config "${{ inputs.gcovr-config }}"
          --json "${artifact_dir}/coverage.json"
        )
        if [[ ! -z "${{ inputs.gcov }}" ]]; then
          gcovr_args+=(--gcov-executable "${{ inputs.gcov }}")
        fi

        mkdir -p "${artifact_dir}"
        gcovr "${gcovr_args[@]}"

        echo "upload-dir=${artifact_dir}" >> "${GITHUB_OUTPUT}"
      shell: ${{ inputs.shell }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test_coverage_data_${{ inputs.artifacts-name }}
        path: ${{ steps.prepare-coverage-artifacts.outputs.upload-dir }}
        retention-days: 1
        if-no-files-found: error

    - name: Clean up temporary files
      run: rm -rf "${{ steps.prepare-coverage-artifacts.outputs.upload-dir }}"
      shell: ${{ inputs.shell }}
